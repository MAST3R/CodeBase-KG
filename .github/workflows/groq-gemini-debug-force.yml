name: Groq + Gemini Debug Runner (force-checkout & run)

on:
  workflow_dispatch: {}

permissions:
  contents: read
  actions: read

env:
  PYTHONUNBUFFERED: "1"
  DEBUG_ARTIFACT_NAME: groq-gemini-debug-logs

jobs:
  debug:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository (full, fetch all commits & submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0        # full history â€” avoids shallow checkout issues
          submodules: true     # in case generator files are in a submodule
          persist-credentials: true

      - name: Show git status & last commit
        run: |
          echo "Current branch / commit:"
          git rev-parse --abbrev-ref HEAD || true
          git rev-parse HEAD || true
          echo "Recent commits:"
          git --no-pager log -n 5 --pretty=oneline || true
          echo "Remote heads:"
          git branch -av || true

      - name: Show generator directory contents (debug)
        run: |
          echo "PWD: $(pwd)"
          echo "List top-level files:"
          ls -la | sed -n '1,200p' || true
          echo "Listing generator/ contents:"
          if [ -d generator ]; then
            ls -la generator || true
            echo "Show top lines of any candidate scripts:"
            for f in generator/*.py; do
              [ -f "$f" ] || continue
              echo "---- HEAD $f ----"
              sed -n '1,120p' "$f" || true
              echo ""
            done
          else
            echo "generator/ directory missing"
          fi

      - name: Check secrets presence (masked)
        run: |
          if [ -z "${GROQ_API_KEY:-}" ]; then echo "GROQ_API_KEY: MISSING"; else echo "GROQ_API_KEY: PRESENT"; fi
          if [ -z "${GEMINI_API_KEY:-}" ]; then echo "GEMINI_API_KEY: MISSING"; else echo "GEMINI_API_KEY: PRESENT"; fi

      - name: Run generator if present (defensive)
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -eux
          mkdir -p debug-logs
          if [ -f generator/groq_generate.py ]; then
            echo "Running generator/groq_generate.py"
            python generator/groq_generate.py 2>&1 | tee debug-logs/groq-generate-$(date -u +"%Y%m%dT%H%M%SZ").log || true
          else
            echo "generator/groq_generate.py not found; skipping run" | tee debug-logs/groq-generate-missing.log
            ls -la generator >> debug-logs/generator-listing.txt || true
          fi

      - name: Collect debug info (resolv, env, net)
        run: |
          set -eux
          echo "--- ENV (filtered) ---" > debug-logs/env.txt
          env | egrep -i 'GROQ|GEMINI|HTTP|HTTPS|PROXY|DNS|HOST|GITHUB' >> debug-logs/env.txt || true
          echo "--- resolv.conf ---" > debug-logs/resolv.txt
          cat /etc/resolv.conf >> debug-logs/resolv.txt || true
          ss -tunap > debug-logs/ss.txt || true
          echo "--- ls debug-logs ---" > debug-logs/listing.txt
          ls -la debug-logs >> debug-logs/listing.txt || true

      - name: Upload debug logs
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DEBUG_ARTIFACT_NAME }}
          path: debug-logs
